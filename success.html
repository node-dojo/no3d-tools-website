<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Confirmed - NO3D Tools</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Success Page - Following Petri UI Design System */
        body {
            background-color: var(--color-stone-gray);
        }

        .site-header .logo img {
            height: 43px;
            width: 274px;
            object-fit: contain;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            padding: 6px;
            display: block;
        }

        .success-container {
            max-width: var(--content-max-width);
            margin: var(--space-xlarge) auto;
            padding: var(--space-large);
        }

        .success-header {
            text-align: center;
            margin-bottom: var(--space-large);
        }

        .success-icon {
            font-size: 60px;
            line-height: 1;
            margin-bottom: var(--space-medium);
        }

        .success-title {
            font-family: var(--font-visitor);
            font-size: var(--font-size-h1);
            font-weight: 700;
            text-transform: uppercase;
            color: var(--color-void-black);
            letter-spacing: var(--letter-spacing-normal);
            margin-bottom: var(--space-small);
            line-height: 1.0;
        }

        .success-subtitle {
            font-family: var(--font-mono);
            font-size: var(--font-size-base);
            color: var(--color-void-black);
            margin-bottom: var(--space-large);
        }

        .action-buttons {
            display: flex;
            gap: var(--space-medium);
            justify-content: center;
            margin-bottom: var(--space-large);
            flex-wrap: wrap;
        }

        .action-button {
            font-family: var(--font-visitor);
            font-size: var(--font-size-h3);
            font-weight: 700;
            text-transform: uppercase;
            padding: var(--space-medium) var(--space-large);
            border: 1px solid var(--color-void-black);
            border-radius: 0;
            cursor: pointer;
            transition: all var(--transition-fast);
            text-decoration: none;
            display: inline-block;
            letter-spacing: var(--letter-spacing-normal);
        }

        .action-button-primary {
            background: var(--color-lello);
            color: var(--color-void-black);
        }

        .action-button-primary:hover {
            background: var(--color-void-black);
            color: var(--color-lello);
        }

        .action-button-secondary {
            background: var(--color-paper-white);
            color: var(--color-void-black);
        }

        .action-button-secondary:hover {
            background: var(--color-void-black);
            color: var(--color-paper-white);
        }

        .purchase-types {
            background: var(--color-paper-white);
            border: 1px solid var(--color-void-black);
            border-radius: 0;
            padding: var(--space-large);
            margin-bottom: var(--space-large);
        }

        .purchase-types h2 {
            font-family: var(--font-visitor);
            font-size: var(--font-size-h2);
            font-weight: 700;
            text-transform: uppercase;
            color: var(--color-void-black);
            letter-spacing: var(--letter-spacing-normal);
            margin-bottom: var(--space-medium);
            line-height: 1.0;
        }

        .purchase-type-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-medium);
        }

        .purchase-type {
            padding: var(--space-medium);
            background: var(--color-stone-gray);
            border-left: 4px solid var(--color-lello);
        }

        .purchase-type-title {
            font-family: var(--font-visitor);
            font-size: var(--font-size-h3);
            font-weight: 700;
            text-transform: uppercase;
            color: var(--color-void-black);
            margin-bottom: var(--space-tiny);
            letter-spacing: var(--letter-spacing-normal);
        }

        .purchase-type-description {
            font-family: var(--font-mono);
            font-size: var(--font-size-base);
            color: var(--color-void-black);
            line-height: 1.4;
        }

        .purchase-type-description a {
            color: var(--color-void-black);
            text-decoration: underline;
        }

        .purchase-type-description a:hover {
            background: var(--color-lello);
        }

        .help-section {
            background: var(--color-paper-white);
            border: 1px solid var(--color-void-black);
            border-radius: 0;
            padding: var(--space-large);
        }

        .help-section h3 {
            font-family: var(--font-visitor);
            font-size: var(--font-size-h3);
            font-weight: 700;
            text-transform: uppercase;
            color: var(--color-void-black);
            letter-spacing: var(--letter-spacing-normal);
            margin-bottom: var(--space-small);
        }

        .help-section p {
            font-family: var(--font-mono);
            font-size: var(--font-size-base);
            color: var(--color-void-black);
            line-height: 1.4;
        }

        @media (max-width: 768px) {
            .success-container {
                padding: var(--space-medium);
            }

            .action-buttons {
                flex-direction: column;
            }

            .action-button {
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="site-container">
        <header class="site-header">
            <div class="header-left">
                <a href="index.html" class="logo">
                    <img src="assets/no3d-tools.png" alt="NO3D TOOLS" class="logo-light">
                </a>
            </div>
            <nav class="header-right">
                <a href="subscribe.html" class="nav-link">SUBSCRIBE</a>
                <a href="account.html" class="nav-link">ACCOUNT</a>
            </nav>
        </header>

        <main class="success-container">
            <div class="success-header">
                <div class="success-icon">‚úì</div>
                <h1 class="success-title">ORDER CONFIRMED</h1>
                <p class="success-subtitle">Check your email for next steps</p>
            </div>

            <div class="action-buttons">
                <a href="account.html" class="action-button action-button-primary">MY ACCOUNT</a>
                <a href="index.html" class="action-button action-button-secondary">BROWSE PRODUCTS</a>
            </div>

            <div class="purchase-types">
                <h2>WHAT HAPPENS NEXT?</h2>
                <div class="purchase-type-list">
                    <div class="purchase-type">
                        <div class="purchase-type-title">üéÅ GIFT CARD PURCHASE</div>
                        <div class="purchase-type-description">
                            Your gift card code has been emailed to you. Forward the email to your recipient so they can redeem it at checkout or on their <a href="account.html">account page</a>.
                        </div>
                    </div>

                    <div class="purchase-type">
                        <div class="purchase-type-title">üíé INDIVIDUAL PRODUCT</div>
                        <div class="purchase-type-description">
                            Download your purchase above. We've also created an account for you using your email‚Äîyou are now logged in! Use the <strong>MY ACCOUNT</strong> page to access your files anytime.
                        </div>
                    </div>

                    <div class="purchase-type">
                        <div class="purchase-type-title">üîÑ SUBSCRIPTION</div>
                        <div class="purchase-type-description">
                            You now have full access to the entire NO3D Tools library! You are automatically logged in. Visit your <a href="account.html">account page</a> to download everything.
                        </div>
                    </div>
                </div>
            </div>

            <div class="help-section">
                <h3>NEED HELP?</h3>
                <p>If you didn't receive your confirmation email or have any questions, contact support@no3d.tools</p>
            </div>
        </main>

        <footer class="site-footer">
            <p>&copy; 2025 NO3D TOOLS. ALL RIGHTS RESERVED.</p>
        </footer>
    </div>

    <script>
        // Clear any cart data from localStorage
        if (typeof Storage !== 'undefined') {
            localStorage.removeItem('cart');
        }

        // Handle Checkout Session verification
        async function initSuccessPage() {
            const urlParams = new URLSearchParams(window.location.search);
            const checkoutSessionId = urlParams.get('checkout_session_id');
            const successContainer = document.querySelector('.success-container');
            const subtitle = document.querySelector('.success-subtitle');
            
            if (checkoutSessionId) {
                console.log('Verifying checkout session:', checkoutSessionId);
                subtitle.textContent = "Verifying your purchase...";
                
                try {
                    const response = await fetch('/api/verify-purchase', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ checkoutSessionId })
                    });
                    
                    const data = await response.json();
                    
                    if (data.email) {
                        console.log('Purchase verified for:', data.email);
                        subtitle.textContent = `Confirmation sent to ${data.email}`;
                        
                        // AUTO-LOGIN: Create a session from the purchase
                        try {
                            const sessionResponse = await fetch('/api/customer/purchase-session', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ checkoutSessionId })
                            });
                            
                            const sessionData = await sessionResponse.json();
                            
                            if (sessionData.success && sessionData.sessionToken) {
                                console.log('Auto-login successful');
                                localStorage.setItem('no3d_session_token', sessionData.sessionToken);
                                localStorage.setItem('customer_email', data.email);

                                // Show logged in message
                                const loginMessage = document.createElement('p');
                                loginMessage.className = 'success-subtitle';
                                loginMessage.style.color = 'var(--color-success-green, #4CAF50)';
                                loginMessage.style.marginTop = 'var(--space-small)';
                                loginMessage.innerHTML = '<strong>‚ú® INSTANT ACCESS:</strong> You are now logged in. Redirecting to your account...';
                                subtitle.parentNode.insertBefore(loginMessage, subtitle.nextSibling);

                                // Auto-redirect to account page after 2 seconds
                                setTimeout(() => {
                                    window.location.href = 'account.html';
                                }, 2000);
                            }
                        } catch (sessionError) {
                            console.error('Auto-login failed:', sessionError);
                        }

                        // Update Account Button with prefilled email (fallback)
                        const accountBtn = document.querySelector('.action-button-primary');
                        if (accountBtn && !localStorage.getItem('no3d_session_token')) {
                            accountBtn.href = `account.html?email=${encodeURIComponent(data.email)}`;
                        }

                        // Try to get download links immediately
                        if (data.ownedProducts && data.ownedProducts.length > 0) {
                            await fetchDownloadLinks(data.email, data.ownedProducts);
                        }
                    }
                } catch (error) {
                    console.error('Verification failed:', error);
                    subtitle.textContent = "Check your email for next steps";
                }
            }
        }

        async function fetchDownloadLinks(email, productIds) {
            try {
                const response = await fetch('/api/get-download-urls', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, productIds })
                });
                
                const data = await response.json();
                
                if (data.downloads && data.downloads.length > 0) {
                    const purchaseTypesDiv = document.querySelector('.purchase-types');
                    
                    // Create downloads section
                    const downloadsHtml = data.downloads.map(d => `
                        <div class="purchase-type" style="border-left-color: var(--color-success-green, #4CAF50);">
                            <div class="purchase-type-title">‚¨áÔ∏è READY TO DOWNLOAD</div>
                            <div class="purchase-type-description">
                                <a href="${d.url}" target="_blank" download>Download ${d.filename}</a>
                            </div>
                        </div>
                    `).join('');

                    const downloadsSection = document.createElement('div');
                    downloadsSection.innerHTML = `
                        <h2>YOUR DOWNLOADS</h2>
                        <div class="purchase-type-list">
                            ${downloadsHtml}
                        </div>
                        <br>
                    `;
                    
                    // Insert before the existing "What Happens Next?" section
                    if (purchaseTypesDiv) {
                        purchaseTypesDiv.parentNode.insertBefore(downloadsSection, purchaseTypesDiv);
                    }
                }
            } catch (error) {
                console.error('Failed to fetch downloads:', error);
            }
        }

        // Run on load
        initSuccessPage();
    </script>
</body>
</html>
