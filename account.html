<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account - NO3D Tools</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Account Page Styles - Following NO3D Tools Design System */
        body {
            background-color: var(--color-stone-gray);
        }
        
        .site-header .logo img {
            height: 43px;
            width: 274px;
            object-fit: contain;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            padding: 6px;
            margin-top: 0px;
            margin-bottom: 0px;
            display: block;
            color: rgba(0, 0, 0, 1);
            font-family: "Visitor TT1 BRK";
            border-color: rgba(0, 0, 0, 0);
            border-image: none;
        }
        
        .account-container {
            max-width: var(--content-max-width);
            margin: var(--space-xlarge) auto;
            padding: var(--space-large);
        }
        
        .account-header {
            margin-bottom: var(--space-large);
        }
        
        .account-header h1 {
            font-family: var(--font-visitor);
            font-size: var(--font-size-h1);
            font-weight: 700;
            text-transform: uppercase;
            color: var(--color-void-black);
            letter-spacing: var(--letter-spacing-normal);
            margin-bottom: var(--space-small);
            line-height: 1.0;
        }
        
        .account-header h2 {
            font-family: var(--font-visitor);
            font-size: var(--font-size-h2);
            font-weight: 700;
            text-transform: uppercase;
            color: var(--color-void-black);
            letter-spacing: var(--letter-spacing-normal);
            margin-bottom: var(--space-medium);
            line-height: 1.0;
        }
        
        .subscription-status,
        .download-section {
            background: var(--color-paper-white);
            border: 1px solid var(--color-void-black);
            border-radius: 0;
            padding: var(--space-large);
            margin-bottom: var(--space-large);
        }
        
        .status-badge {
            display: inline-block;
            padding: var(--space-tiny) var(--space-medium);
            border-radius: 0;
            font-family: var(--font-visitor);
            font-size: var(--font-size-h3);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: var(--letter-spacing-normal);
            margin-bottom: var(--space-medium);
            border: 1px solid var(--color-void-black);
        }
        
        .status-badge.active {
            background: var(--color-lello);
            color: var(--color-void-black);
        }
        
        .status-badge.expired {
            background: var(--color-void-black);
            color: var(--color-paper-white);
        }
        
        .status-badge.inactive {
            background: var(--color-dark-gray);
            color: var(--color-paper-white);
        }
        
        .subscription-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-medium);
            margin: var(--space-medium) 0;
        }
        
        .info-item {
            padding: var(--space-medium);
            background: var(--color-stone-gray);
            border: 1px solid var(--color-void-black);
            border-radius: 0;
        }
        
        .info-label {
            font-family: var(--font-mono);
            font-size: 11px;
            font-weight: var(--font-mono-weight);
            color: var(--color-dark-gray);
            margin-bottom: var(--space-tiny);
            text-transform: uppercase;
            letter-spacing: var(--letter-spacing-normal);
        }
        
        .info-value {
            font-family: var(--font-visitor);
            font-size: var(--font-size-h3);
            font-weight: 700;
            color: var(--color-void-black);
            text-transform: uppercase;
            letter-spacing: var(--letter-spacing-normal);
        }
        
        .download-button {
            background-color: var(--color-lello);
            color: var(--color-void-black);
            border: 1px solid var(--color-void-black);
            padding: var(--space-small) var(--space-large);
            font-family: var(--font-visitor);
            font-size: var(--font-size-h2);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: var(--letter-spacing-normal);
            cursor: pointer;
            transition: all var(--transition-normal);
            border-radius: 0;
            display: inline-block;
            margin: var(--space-medium) 0;
            text-decoration: none;
            line-height: 1.0;
            width: auto;
            min-width: auto;
            height: auto;
        }
        
        .download-button:hover:not(:disabled) {
            background-color: var(--color-lello-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lello-glow);
        }
        
        .download-button:active:not(:disabled) {
            background-color: #d4e600;
            transform: translateY(0);
        }
        
        .download-button:disabled {
            background: var(--color-stone-gray);
            color: var(--color-medium-gray);
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .update-badge {
            display: inline-block;
            padding: var(--space-tiny) var(--space-medium);
            background: var(--color-lello);
            color: var(--color-void-black);
            border: 1px solid var(--color-void-black);
            border-radius: 0;
            margin-left: var(--space-medium);
            font-family: var(--font-visitor);
            font-size: var(--font-size-small);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: var(--letter-spacing-normal);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .account-actions {
            display: flex;
            gap: var(--space-medium);
            flex-wrap: wrap;
            margin-top: var(--space-medium);
        }
        
        .action-link {
            color: var(--color-void-black);
            text-decoration: none;
            padding: var(--space-tiny) var(--space-medium);
            border: 1px solid var(--color-void-black);
            border-radius: 0;
            transition: all var(--transition-normal);
            font-family: var(--font-visitor);
            font-size: var(--font-size-h3);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: var(--letter-spacing-normal);
            background: var(--color-paper-white);
        }
        
        .action-link:hover {
            background: var(--color-lello);
            color: var(--color-void-black);
            transform: translateY(-1px);
        }
        
        .loading {
            text-align: center;
            padding: var(--space-xlarge);
            color: var(--color-dark-gray);
            font-family: var(--font-mono);
            font-size: var(--font-size-base);
        }
        
        .error-message {
            background: var(--color-paper-white);
            color: var(--color-void-black);
            padding: var(--space-medium);
            border: 1px solid var(--color-void-black);
            border-radius: 0;
            margin: var(--space-medium) 0;
            font-family: var(--font-mono);
            font-size: var(--font-size-base);
        }
        
        .login-prompt {
            text-align: center;
            padding: var(--space-xlarge) var(--space-large);
        }
        
        .login-prompt h2 {
            font-family: var(--font-visitor);
            font-size: var(--font-size-h2);
            font-weight: 700;
            text-transform: uppercase;
            color: var(--color-void-black);
            margin-bottom: var(--space-medium);
        }
        
        .login-prompt p {
            font-family: var(--font-mono);
            font-size: var(--font-size-base);
            color: var(--color-dark-gray);
            margin-bottom: var(--space-medium);
        }
        
        .login-button {
            background-color: var(--color-lello);
            color: var(--color-void-black);
            border: 1px solid var(--color-void-black);
            padding: var(--space-small) var(--space-large);
            font-family: var(--font-visitor);
            font-size: var(--font-size-h2);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: var(--letter-spacing-normal);
            text-decoration: none;
            display: inline-block;
            margin-top: var(--space-medium);
            border-radius: 0;
            transition: all var(--transition-normal);
        }
        
        .login-button:hover {
            background-color: var(--color-lello-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lello-glow);
        }
        
        .download-section h2 {
            font-family: "Visitor TT1 BRK";
        }
        
        .download-section p {
            font-family: var(--font-mono);
            font-size: var(--font-size-base);
            color: var(--color-void-black);
            margin-bottom: var(--space-medium);
            line-height: var(--line-height-base);
            padding-top: 7px;
            padding-bottom: 7px;
        }
        
        #last-download {
            font-family: "JetBrains Mono";
            font-size: var(--font-size-small);
            color: var(--color-dark-gray);
            margin-top: var(--space-medium);
        }
        
        #download-progress {
            font-family: var(--font-mono);
            font-size: var(--font-size-base);
            color: var(--color-dark-gray);
            margin-top: var(--space-medium);
        }
        
        .library-files-section {
            background: var(--color-paper-white);
            border: 1px solid var(--color-void-black);
            border-radius: 0;
            padding: var(--space-large);
            margin-bottom: var(--space-large);
        }
        
        .library-files-section h2 {
            font-family: var(--font-visitor);
            font-size: var(--font-size-h2);
            font-weight: 700;
            text-transform: uppercase;
            color: var(--color-void-black);
            letter-spacing: var(--letter-spacing-normal);
            margin-bottom: var(--space-medium);
            line-height: 1.0;
        }
        
        .library-files-section p {
            font-family: var(--font-mono);
            font-size: var(--font-size-base);
            color: var(--color-void-black);
            margin-bottom: var(--space-medium);
            line-height: var(--line-height-base);
        }
        
        .library-files-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: var(--space-medium);
            margin-top: var(--space-medium);
        }
        
        .library-file-item {
            background: var(--color-stone-gray);
            border: 1px solid var(--color-void-black);
            border-radius: 0;
            padding: var(--space-medium);
            display: flex;
            flex-direction: column;
            gap: var(--space-small);
            transition: all var(--transition-fast);
            position: relative;
        }
        
        .library-file-item:hover {
            background: rgba(240, 255, 0, 0.1);
            border-color: var(--color-void-black);
        }
        
        .library-file-name {
            font-family: var(--font-visitor);
            font-size: var(--font-size-h3);
            font-weight: 700;
            text-transform: uppercase;
            color: var(--color-void-black);
            letter-spacing: var(--letter-spacing-normal);
            line-height: 1.0;
        }
        
        .library-file-path {
            font-family: var(--font-mono);
            font-size: var(--font-size-small);
            color: var(--color-dark-gray);
            word-break: break-all;
        }
        
        .library-file-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--space-tiny);
            font-family: var(--font-mono);
            font-size: var(--font-size-micro);
            color: var(--color-medium-gray);
        }
        
        .library-files-empty {
            text-align: center;
            padding: var(--space-xlarge);
            color: var(--color-dark-gray);
            font-family: var(--font-mono);
            font-size: var(--font-size-base);
        }

        .library-file-download-icon {
            position: absolute;
            top: var(--space-small);
            right: var(--space-small);
            width: 24px;
            height: 24px;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity var(--transition-fast);
            z-index: 10;
        }

        .library-file-download-icon:hover {
            opacity: 1;
        }

        .library-file-download-icon svg {
            width: 100%;
            height: 100%;
            fill: var(--color-void-black);
        }

        /* Credit Balance Section */
        .credit-section {
            background: var(--color-paper-white);
            border: 1px solid var(--color-void-black);
            border-radius: 0;
            padding: var(--space-large);
            margin-bottom: var(--space-large);
        }

        .credit-section h2 {
            font-family: var(--font-visitor);
            font-size: var(--font-size-h2);
            font-weight: 700;
            text-transform: uppercase;
            color: var(--color-void-black);
            letter-spacing: var(--letter-spacing-normal);
            margin-bottom: var(--space-medium);
            line-height: 1.0;
        }

        .credit-balance-display {
            display: flex;
            align-items: center;
            gap: var(--space-large);
            margin-bottom: var(--space-medium);
        }

        .credit-amount {
            font-family: var(--font-visitor);
            font-size: 48px;
            font-weight: 700;
            color: var(--color-void-black);
            line-height: 1.0;
        }

        .credit-amount.has-credit {
            color: var(--color-lello);
            background: var(--color-void-black);
            padding: var(--space-small) var(--space-medium);
            border: 1px solid var(--color-void-black);
        }

        .redeem-section {
            margin-top: var(--space-medium);
            padding-top: var(--space-medium);
            border-top: 1px solid var(--color-stone-gray);
        }

        .redeem-form {
            display: flex;
            gap: var(--space-small);
            flex-wrap: wrap;
            align-items: flex-start;
        }

        .redeem-input {
            flex: 1;
            min-width: 200px;
            padding: var(--space-small) var(--space-medium);
            font-family: var(--font-mono);
            font-size: var(--font-size-base);
            border: 1px solid var(--color-void-black);
            border-radius: 0;
            text-transform: uppercase;
            letter-spacing: 2px;
            background: var(--color-paper-white);
        }

        .redeem-input::placeholder {
            text-transform: none;
            letter-spacing: normal;
            color: var(--color-medium-gray);
        }

        .redeem-input:focus {
            outline: none;
            border-color: var(--color-lello);
            box-shadow: 0 0 0 2px rgba(240, 255, 0, 0.3);
        }

        .redeem-button {
            background-color: var(--color-void-black);
            color: var(--color-paper-white);
            border: 1px solid var(--color-void-black);
            padding: var(--space-small) var(--space-large);
            font-family: var(--font-visitor);
            font-size: var(--font-size-h3);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: var(--letter-spacing-normal);
            cursor: pointer;
            transition: all var(--transition-normal);
            border-radius: 0;
        }

        .redeem-button:hover:not(:disabled) {
            background-color: var(--color-lello);
            color: var(--color-void-black);
        }

        .redeem-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .redeem-message {
            margin-top: var(--space-small);
            font-family: var(--font-mono);
            font-size: var(--font-size-small);
            padding: var(--space-small);
        }

        .redeem-message.success {
            background: rgba(240, 255, 0, 0.2);
            color: var(--color-void-black);
            border: 1px solid var(--color-lello);
        }

        .redeem-message.error {
            background: rgba(255, 0, 0, 0.1);
            color: #cc0000;
            border: 1px solid #cc0000;
        }

        .credit-history {
            margin-top: var(--space-medium);
        }

        .credit-history h3 {
            font-family: var(--font-visitor);
            font-size: var(--font-size-h3);
            font-weight: 700;
            text-transform: uppercase;
            color: var(--color-void-black);
            margin-bottom: var(--space-small);
        }

        .credit-history-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .credit-history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-small);
            border-bottom: 1px solid var(--color-stone-gray);
            font-family: var(--font-mono);
            font-size: var(--font-size-small);
        }

        .credit-history-item:last-child {
            border-bottom: none;
        }

        .credit-history-amount {
            font-weight: bold;
        }

        .credit-history-amount.positive {
            color: #00aa00;
        }

        .credit-history-amount.negative {
            color: #cc0000;
        }

        .credit-history-date {
            color: var(--color-medium-gray);
            font-size: var(--font-size-micro);
        }

        .credit-history-empty {
            color: var(--color-medium-gray);
            font-family: var(--font-mono);
            font-size: var(--font-size-small);
            padding: var(--space-medium);
            text-align: center;
        }

        /* Purchased Gift Cards Section */
        .purchased-giftcards {
            margin-top: var(--space-medium);
            padding-top: var(--space-medium);
            border-top: 1px solid var(--color-stone-gray);
        }

        .purchased-giftcards h3 {
            font-family: var(--font-visitor);
            font-size: var(--font-size-h3);
            font-weight: 700;
            text-transform: uppercase;
            color: var(--color-void-black);
            margin-bottom: var(--space-small);
        }

        .purchased-giftcards-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-small);
        }

        .giftcard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-medium);
            background: var(--color-stone-gray);
            border-left: 4px solid var(--color-lello);
            font-family: var(--font-mono);
        }

        .giftcard-item.redeemed {
            opacity: 0.6;
            border-left-color: var(--color-medium-gray);
        }

        .giftcard-info {
            display: flex;
            flex-direction: column;
            gap: var(--space-tiny);
        }

        .giftcard-code {
            font-family: var(--font-visitor);
            font-size: var(--font-size-base);
            font-weight: 700;
            color: var(--color-void-black);
            letter-spacing: 2px;
        }

        .giftcard-details {
            font-size: var(--font-size-small);
            color: var(--color-dark-gray);
        }

        .giftcard-value {
            font-family: var(--font-visitor);
            font-size: var(--font-size-h3);
            font-weight: 700;
            color: var(--color-void-black);
        }

        .giftcard-status {
            display: inline-block;
            padding: var(--space-tiny) var(--space-small);
            font-family: var(--font-visitor);
            font-size: var(--font-size-micro);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 1px solid var(--color-void-black);
        }

        .giftcard-status.active {
            background: var(--color-lello);
            color: var(--color-void-black);
        }

        .giftcard-status.redeemed {
            background: var(--color-medium-gray);
            color: var(--color-paper-white);
        }

        .purchased-giftcards-empty {
            color: var(--color-medium-gray);
            font-family: var(--font-mono);
            font-size: var(--font-size-small);
            padding: var(--space-medium);
            text-align: center;
        }

        /* Orders Section Styles */
        .orders-section {
            background: var(--color-paper-white);
            border: 1px solid var(--color-void-black);
            border-radius: 0;
            padding: var(--space-large);
            margin-bottom: var(--space-large);
        }

        .orders-section h2 {
            font-family: var(--font-visitor);
            font-size: var(--font-size-h2);
            font-weight: 700;
            text-transform: uppercase;
            color: var(--color-void-black);
            letter-spacing: var(--letter-spacing-normal);
            margin-bottom: var(--space-medium);
            line-height: 1.0;
        }

        .orders-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-medium);
            margin-top: var(--space-medium);
        }

        .order-card {
            background: var(--color-stone-gray);
            border: 1px solid var(--color-void-black);
            border-radius: 0;
            padding: var(--space-medium);
            transition: all var(--transition-fast);
        }

        .order-card:hover {
            background: rgba(240, 255, 0, 0.1);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-small);
            flex-wrap: wrap;
            gap: var(--space-small);
        }

        .order-id {
            font-family: var(--font-mono);
            font-size: var(--font-size-small);
            color: var(--color-dark-gray);
        }

        .order-date {
            font-family: var(--font-mono);
            font-size: var(--font-size-small);
            color: var(--color-medium-gray);
        }

        .order-status {
            display: inline-block;
            padding: var(--space-tiny) var(--space-small);
            border: 1px solid var(--color-void-black);
            font-family: var(--font-visitor);
            font-size: var(--font-size-micro);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: var(--letter-spacing-normal);
        }

        .order-status.paid {
            background: var(--color-lello);
            color: var(--color-void-black);
        }

        .order-status.pending {
            background: var(--color-paper-white);
            color: var(--color-dark-gray);
        }

        .order-products {
            margin: var(--space-small) 0;
        }

        .order-product {
            font-family: var(--font-visitor);
            font-size: var(--font-size-h3);
            font-weight: 700;
            color: var(--color-void-black);
            text-transform: uppercase;
            margin-bottom: var(--space-tiny);
        }

        .order-amount {
            font-family: var(--font-visitor);
            font-size: var(--font-size-h2);
            font-weight: 700;
            color: var(--color-void-black);
            margin-top: var(--space-small);
        }

        .order-actions {
            display: flex;
            gap: var(--space-small);
            margin-top: var(--space-small);
            flex-wrap: wrap;
        }

        .order-invoice-link {
            font-family: var(--font-visitor);
            font-size: var(--font-size-small);
            color: var(--color-void-black);
            text-decoration: none;
            padding: var(--space-tiny) var(--space-small);
            border: 1px solid var(--color-void-black);
            transition: all var(--transition-fast);
        }

        .order-invoice-link:hover {
            background: var(--color-lello);
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: var(--space-small);
            margin-top: var(--space-large);
        }

        .pagination-button {
            background: var(--color-paper-white);
            color: var(--color-void-black);
            border: 1px solid var(--color-void-black);
            padding: var(--space-tiny) var(--space-medium);
            font-family: var(--font-visitor);
            font-size: var(--font-size-small);
            font-weight: 700;
            text-transform: uppercase;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .pagination-button:hover:not(:disabled) {
            background: var(--color-lello);
        }

        .pagination-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .pagination-info {
            font-family: var(--font-mono);
            font-size: var(--font-size-small);
            color: var(--color-dark-gray);
        }

        .orders-empty {
            text-align: center;
            padding: var(--space-xlarge);
            color: var(--color-dark-gray);
            font-family: var(--font-mono);
            font-size: var(--font-size-base);
        }

        /* Magic Link Auth Styles */
        .auth-form {
            max-width: 500px;
            margin: 0 auto;
        }

        .auth-input {
            width: 100%;
            padding: var(--space-small) var(--space-medium);
            font-family: var(--font-mono);
            font-size: var(--font-size-base);
            border: 1px solid var(--color-void-black);
            border-radius: 0;
            margin-bottom: var(--space-small);
            background: var(--color-paper-white);
            box-sizing: border-box;
        }

        .auth-input:focus {
            outline: none;
            border-color: var(--color-lello);
            box-shadow: 0 0 0 2px rgba(240, 255, 0, 0.3);
        }

        .auth-button {
            width: 100%;
            background-color: var(--color-lello);
            color: var(--color-void-black);
            border: 1px solid var(--color-void-black);
            padding: var(--space-small) var(--space-large);
            font-family: var(--font-visitor);
            font-size: var(--font-size-h2);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: var(--letter-spacing-normal);
            cursor: pointer;
            transition: all var(--transition-normal);
            border-radius: 0;
            box-sizing: border-box;
        }

        .auth-button:hover:not(:disabled) {
            background-color: var(--color-lello-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lello-glow);
        }

        .auth-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .auth-message {
            margin-top: var(--space-small);
            font-family: var(--font-mono);
            font-size: var(--font-size-small);
            padding: var(--space-small);
            border-radius: 0;
        }

        .auth-message.success {
            background: rgba(240, 255, 0, 0.2);
            color: var(--color-void-black);
            border: 1px solid var(--color-lello);
        }

        .auth-message.error {
            background: rgba(255, 0, 0, 0.1);
            color: #cc0000;
            border: 1px solid #cc0000;
        }

        .auth-message.info {
            background: rgba(0, 100, 255, 0.1);
            color: #0066cc;
            border: 1px solid #0066cc;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--color-paper-white);
            border: 2px solid var(--color-void-black);
            border-radius: 0;
            padding: var(--space-large);
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .modal-content h3 {
            font-family: var(--font-visitor);
            font-size: var(--font-size-h2);
            font-weight: 700;
            text-transform: uppercase;
            color: var(--color-void-black);
            margin-bottom: var(--space-medium);
            line-height: 1.0;
        }

        .modal-content p {
            font-family: var(--font-mono);
            font-size: var(--font-size-base);
            color: var(--color-void-black);
            margin-bottom: var(--space-medium);
            line-height: var(--line-height-base);
        }

        .cancel-options {
            display: flex;
            flex-direction: column;
            gap: var(--space-small);
            margin-bottom: var(--space-medium);
        }

        .cancel-options label {
            display: flex;
            align-items: center;
            padding: var(--space-small);
            background: var(--color-stone-gray);
            border: 2px solid transparent;
            cursor: pointer;
            transition: all var(--transition-fast);
            font-family: var(--font-mono);
            font-size: var(--font-size-base);
        }

        .cancel-options label:hover {
            background: rgba(240, 255, 0, 0.1);
            border-color: var(--color-lello);
        }

        .cancel-options input[type="radio"] {
            margin-right: var(--space-small);
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .cancel-reason {
            margin-bottom: var(--space-medium);
        }

        .cancel-reason label {
            display: block;
            font-family: var(--font-mono);
            font-size: var(--font-size-small);
            color: var(--color-dark-gray);
            margin-bottom: var(--space-tiny);
            text-transform: uppercase;
        }

        .cancel-reason select {
            width: 100%;
            padding: var(--space-small);
            font-family: var(--font-mono);
            font-size: var(--font-size-base);
            border: 1px solid var(--color-void-black);
            border-radius: 0;
            background: var(--color-paper-white);
            cursor: pointer;
        }

        .cancel-reason select:focus {
            outline: none;
            border-color: var(--color-lello);
            box-shadow: 0 0 0 2px rgba(240, 255, 0, 0.3);
        }

        .modal-actions {
            display: flex;
            gap: var(--space-small);
            justify-content: flex-end;
            margin-top: var(--space-medium);
        }

        .modal-actions button {
            padding: var(--space-small) var(--space-medium);
        }

        .warning-message {
            background: rgba(255, 200, 0, 0.1);
            border: 1px solid #ffc800;
            padding: var(--space-small);
            margin-top: var(--space-medium);
            font-family: var(--font-mono);
            font-size: var(--font-size-small);
            color: var(--color-void-black);
        }

        .subscription-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-medium);
            margin-top: var(--space-medium);
        }

        .subscription-card {
            background: var(--color-stone-gray);
            border: 1px solid var(--color-void-black);
            padding: var(--space-medium);
            border-radius: 0;
        }

        .subscription-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-medium);
        }

        .subscription-product-name {
            font-family: var(--font-visitor);
            font-size: var(--font-size-h3);
            font-weight: 700;
            text-transform: uppercase;
            color: var(--color-void-black);
        }

        .subscription-price {
            font-family: var(--font-visitor);
            font-size: var(--font-size-h3);
            font-weight: 700;
            color: var(--color-void-black);
        }

        .subscription-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--space-small);
            margin-bottom: var(--space-small);
        }

        .subscription-detail {
            font-family: var(--font-mono);
            font-size: var(--font-size-small);
        }

        .subscription-detail-label {
            color: var(--color-dark-gray);
            text-transform: uppercase;
            font-size: var(--font-size-micro);
        }

        .subscription-actions {
            display: flex;
            gap: var(--space-small);
            margin-top: var(--space-medium);
            flex-wrap: wrap;
        }

        .subscription-actions button {
            padding: var(--space-tiny) var(--space-medium);
            font-size: var(--font-size-base);
            border: 1px solid var(--color-void-black);
            background: var(--color-paper-white);
            color: var(--color-void-black);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-family: var(--font-visitor);
            font-weight: 700;
            text-transform: uppercase;
        }

        .subscription-actions button:hover:not(:disabled) {
            background: var(--color-lello);
            transform: translateY(-1px);
        }

        .subscription-actions button.danger {
            color: #cc0000;
            border-color: #cc0000;
        }

        .subscription-actions button.danger:hover:not(:disabled) {
            background: #cc0000;
            color: var(--color-paper-white);
        }

        .subscription-actions button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <header class="site-header">
        <div class="header-left">
            <a href="index.html" class="logo">
                <img src="assets/light/no3d-tools.png" alt="NO3D Tools" class="logo">
            </a>
        </div>
        <div class="header-icons">
            <a href="subscribe.html" class="action-link" id="subscribe-header-link" style="display: inline-block; padding: var(--space-tiny) var(--space-medium);">Subscribe</a>
            <a href="account.html" class="action-link" style="display: inline-block; padding: var(--space-tiny) var(--space-medium); background: var(--color-lello);">Account</a>
        </div>
    </header>

    <main class="site-container">
        <div class="account-container">
            <div class="account-header">
                <h1>Welcome, Initiate.</h1>
                <h2>Behold.. your stuff.</h2>
            </div>

            <!-- Loading State -->
            <div id="loading-state" class="loading">
                Loading account information...
            </div>

            <!-- Error State -->
            <div id="error-state" class="error-message" style="display: none;">
                <strong>Error:</strong> <span id="error-message"></span>
            </div>

            <!-- Login Prompt -->
            <div id="login-prompt" class="login-prompt" style="display: none;">
                <!-- Login Form -->
                <div id="login-form-container">
                    <h2>Sign In to Your Account</h2>
                    <p>Enter your email and password to access your account.</p>
                    <div class="auth-form">
                        <input type="email"
                               id="auth-email"
                               class="auth-input"
                               placeholder="your@email.com"
                               autocomplete="email"
                               required>
                        <input type="password"
                               id="auth-password"
                               class="auth-input"
                               placeholder="Password"
                               autocomplete="current-password"
                               required
                               style="margin-top: var(--space-small);">
                        <button class="auth-button" id="login-button" onclick="handleLogin()">
                            Sign In
                        </button>
                        <div id="auth-message" class="auth-message" style="display: none;"></div>
                        <p class="auth-toggle" style="margin-top: var(--space-medium); font-family: var(--font-mono); font-size: var(--font-size-small);">
                            Don't have an account? <a href="#" onclick="showRegisterForm(); return false;" style="color: var(--color-accent);">Create one</a>
                        </p>
                    </div>
                </div>

                <!-- Register Form -->
                <div id="register-form-container" style="display: none;">
                    <h2>Create Your Account</h2>
                    <p>Sign up to access your purchases and manage your account.</p>
                    <div class="auth-form">
                        <input type="email"
                               id="register-email"
                               class="auth-input"
                               placeholder="your@email.com"
                               autocomplete="email"
                               required>
                        <input type="password"
                               id="register-password"
                               class="auth-input"
                               placeholder="Password (min 8 characters)"
                               autocomplete="new-password"
                               required
                               style="margin-top: var(--space-small);">
                        <input type="password"
                               id="register-password-confirm"
                               class="auth-input"
                               placeholder="Confirm Password"
                               autocomplete="new-password"
                               required
                               style="margin-top: var(--space-small);">
                        <button class="auth-button" id="register-button" onclick="handleRegister()">
                            Create Account
                        </button>
                        <div id="register-message" class="auth-message" style="display: none;"></div>
                        <p class="auth-toggle" style="margin-top: var(--space-medium); font-family: var(--font-mono); font-size: var(--font-size-small);">
                            Already have an account? <a href="#" onclick="showLoginForm(); return false;" style="color: var(--color-accent);">Sign in</a>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Name and Email Info Items -->
            <div class="info-item">
                <div class="info-label">Name</div>
                <div class="info-value" id="customer-name">-</div>
            </div>
            <div class="info-item">
                <div class="info-label">Email</div>
                <div class="info-value" id="customer-email" style="font-size: var(--font-size-base); font-weight: normal; text-transform: none;">-</div>
            </div>

            <!-- Account Content -->
            <div id="account-content" style="display: none;">
                <!-- Subscription Status -->
                <div class="subscription-status">
                    <h2>Subscription Management</h2>
                    <div id="subscriptions-list" class="subscription-list">
                        <div class="loading">Loading subscriptions...</div>
                    </div>
                </div>

                <!-- Credit Balance Section -->
                <div class="credit-section">
                    <h2>Store Credit</h2>
                    <div class="credit-balance-display">
                        <span class="credit-amount" id="credit-balance">$0.00</span>
                    </div>

                    <div class="redeem-section">
                        <p style="font-family: var(--font-mono); font-size: var(--font-size-small); color: var(--color-dark-gray); margin-bottom: var(--space-small);">
                            Have a gift card code? Enter it below to add credit to your account.
                        </p>
                        <div class="redeem-form">
                            <input type="text"
                                   id="gift-card-code"
                                   class="redeem-input"
                                   placeholder="DOJO-XXXX-XXXX-XXXX"
                                   maxlength="19"
                                   autocomplete="off">
                            <button class="redeem-button" id="redeem-button" onclick="redeemGiftCard()">
                                Redeem
                            </button>
                        </div>
                        <div id="redeem-message" class="redeem-message" style="display: none;"></div>
                    </div>

                    <!-- Purchased Gift Cards Section -->
                    <div class="purchased-giftcards" id="purchased-giftcards-container" style="display: none;">
                        <h3>Your Gift Cards</h3>
                        <p style="font-family: var(--font-mono); font-size: var(--font-size-small); color: var(--color-dark-gray); margin-bottom: var(--space-small);">
                            Gift cards you've purchased. Share these codes with recipients or redeem them yourself.
                        </p>
                        <div class="purchased-giftcards-list" id="purchased-giftcards-list">
                            <!-- Gift cards populated by JS -->
                        </div>
                    </div>

                    <div class="credit-history" id="credit-history-container" style="display: none;">
                        <h3>Transaction History</h3>
                        <div class="credit-history-list" id="credit-history-list">
                            <!-- Transactions populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- Orders Section -->
                <div class="orders-section">
                    <h2>Order History</h2>
                    <div id="orders-list" class="orders-list">
                        <div class="loading">Loading orders...</div>
                    </div>
                    <div id="orders-pagination" class="pagination" style="display: none;">
                        <!-- Pagination populated by JS -->
                    </div>
                </div>

                <!-- Library Files Section -->
                <div class="library-files-section">
                    <h2>Library Files</h2>
                    <p>Your purchased products and files available for download.</p>
                    <div id="library-files-list" class="library-files-list">
                        <div class="loading">Loading library files...</div>
                    </div>
                </div>

                <!-- Download Section -->
                <div class="download-section">
                    <h2>Library Download</h2>
                    <p>Download the complete NO3D Tools library as a ZIP file. Includes all products currently available.</p>
                    <button class="download-button" id="download-all-button" onclick="downloadAllFiles()">
                        Download All Files
                    </button>
                    <div id="download-progress" style="display: none; margin-top: 1rem;">
                        <p>Preparing download... This may take a moment.</p>
                    </div>
                    <div id="last-download" style="margin-top: 1rem; color: #666; font-size: 0.9rem;">
                        Last downloaded: <span id="last-download-date">Never</span>
                    </div>
                </div>

                <!-- Account Actions -->
                <div class="account-actions">
                    <a href="#" class="action-link" id="billing-link">Manage Billing</a>
                    <a href="subscribe.html" class="action-link">Change Plan</a>
                    <a href="#" class="action-link" id="logout-link" onclick="handleLogout(event)">Sign Out</a>
                </div>
            </div>
        </div>
    </main>

    <!-- Cancellation Modal -->
    <div id="cancel-modal" class="modal">
        <div class="modal-content">
            <h3>Cancel Subscription</h3>
            <p>Choose how you'd like to cancel:</p>
            <div class="cancel-options">
                <label>
                    <input type="radio" name="cancel-type" value="period-end" checked>
                    Cancel at period end (keep access until renewal date)
                </label>
                <label>
                    <input type="radio" name="cancel-type" value="immediately">
                    Cancel immediately (lose access now)
                </label>
            </div>
            <div class="cancel-reason">
                <label>Reason (optional):</label>
                <select id="cancel-reason">
                    <option value="">Select a reason</option>
                    <option value="too_expensive">Too expensive</option>
                    <option value="not_using">Not using enough</option>
                    <option value="missing_features">Missing features I need</option>
                    <option value="switching_service">Switching to another service</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="modal-actions">
                <button onclick="closeCancelModal()" class="action-link">Keep Subscription</button>
                <button onclick="confirmCancel()" class="download-button" style="background: #cc0000; color: white;">Confirm Cancel</button>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p class="footer-text">&copy; 2025 NO3D Tools. All rights reserved.</p>
    </footer>

    <script>
        let customerId = null;
        let subscriptionData = null;
        let catalogVersion = null;
        let sessionToken = null;

        // Initialize account page
        document.addEventListener('DOMContentLoaded', async () => {
            // Check for email param to prefill login
            const urlParams = new URLSearchParams(window.location.search);
            const prefillEmail = urlParams.get('email');
            if (prefillEmail) {
                const emailInput = document.getElementById('email');
                if (emailInput) emailInput.value = prefillEmail;
            }

            // Check if user is already logged in
            const session = await checkSession();


        async function checkAuthentication() {
            // Check for session token in localStorage
            sessionToken = localStorage.getItem('no3d_session_token');

            // Check for magic link token in URL
            const urlParams = new URLSearchParams(window.location.search);
            const magicLinkToken = urlParams.get('token');

            if (magicLinkToken) {
                // Verify magic link token
                await verifyMagicLinkToken(magicLinkToken);
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }

            if (sessionToken) {
                await loadAccountData();
            } else {
                showLoginPrompt();
            }
        }

        function showLoginPrompt() {
            document.getElementById('loading-state').style.display = 'none';
            document.getElementById('login-prompt').style.display = 'block';
        }

        /**
         * Toggle between login and register forms
         */
        function showLoginForm() {
            document.getElementById('login-form-container').style.display = 'block';
            document.getElementById('register-form-container').style.display = 'none';
            // Clear any messages
            document.getElementById('auth-message').style.display = 'none';
            const registerMsg = document.getElementById('register-message');
            if (registerMsg) registerMsg.style.display = 'none';
        }

        function showRegisterForm() {
            document.getElementById('login-form-container').style.display = 'none';
            document.getElementById('register-form-container').style.display = 'block';
            // Clear any messages
            document.getElementById('auth-message').style.display = 'none';
            const registerMsg = document.getElementById('register-message');
            if (registerMsg) registerMsg.style.display = 'none';
        }

        /**
         * Show message in register form
         */
        function showRegisterMessage(message, type) {
            const messageDiv = document.getElementById('register-message');
            if (!messageDiv) return;
            messageDiv.textContent = message;
            messageDiv.className = 'auth-message ' + type;
            messageDiv.style.display = 'block';
        }

        /**
         * Handle login form submission
         */
        async function handleLogin() {
            const emailInput = document.getElementById('auth-email');
            const passwordInput = document.getElementById('auth-password');
            const loginButton = document.getElementById('login-button');

            const email = emailInput.value.trim();
            const password = passwordInput.value;

            if (!email || !isValidEmail(email)) {
                showAuthMessage('Please enter a valid email address', 'error');
                return;
            }

            if (!password) {
                showAuthMessage('Please enter your password', 'error');
                return;
            }

            // Disable button during request
            loginButton.disabled = true;
            loginButton.textContent = 'Signing in...';

            try {
                const response = await fetch('/api/customer/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password }),
                });

                const data = await response.json();

                if (data.success) {
                    // Store session token
                    sessionToken = data.sessionToken;
                    localStorage.setItem('no3d_session_token', sessionToken);

                    // Store customer info
                    customerId = data.customer.id;
                    customerEmail = data.customer.email;
                    localStorage.setItem('customer_email', customerEmail);

                    // Load account data
                    await loadAccountData();
                } else {
                    showAuthMessage(data.error || 'Invalid email or password', 'error');
                }
            } catch (error) {
                console.error('Error logging in:', error);
                showAuthMessage('An error occurred. Please try again.', 'error');
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = 'Sign In';
            }
        }

        /**
         * Handle registration form submission
         */
        async function handleRegister() {
            const emailInput = document.getElementById('register-email');
            const passwordInput = document.getElementById('register-password');
            const confirmInput = document.getElementById('register-password-confirm');
            const registerButton = document.getElementById('register-button');

            const email = emailInput.value.trim();
            const password = passwordInput.value;
            const confirmPassword = confirmInput.value;

            if (!email || !isValidEmail(email)) {
                showRegisterMessage('Please enter a valid email address', 'error');
                return;
            }

            if (!password || password.length < 8) {
                showRegisterMessage('Password must be at least 8 characters', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showRegisterMessage('Passwords do not match', 'error');
                return;
            }

            // Disable button during request
            registerButton.disabled = true;
            registerButton.textContent = 'Creating account...';

            try {
                const response = await fetch('/api/customer/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password }),
                });

                const data = await response.json();

                if (data.success) {
                    // Store session token
                    sessionToken = data.sessionToken;
                    localStorage.setItem('no3d_session_token', sessionToken);

                    // Store customer info
                    customerId = data.customer.id;
                    customerEmail = data.customer.email;
                    localStorage.setItem('customer_email', customerEmail);

                    // Load account data
                    await loadAccountData();
                } else {
                    showRegisterMessage(data.error || 'Registration failed', 'error');
                }
            } catch (error) {
                console.error('Error registering:', error);
                showRegisterMessage('An error occurred. Please try again.', 'error');
            } finally {
                registerButton.disabled = false;
                registerButton.textContent = 'Create Account';
            }
        }

        /**
         * Verify magic link token and create session
         */
        async function verifyMagicLinkToken(token) {
            document.getElementById('loading-state').style.display = 'block';
            document.getElementById('login-prompt').style.display = 'none';

            try {
                const response = await fetch('/api/customer/session', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ token: token }),
                });

                const data = await response.json();

                if (data.success) {
                    // Store session token in localStorage
                    sessionToken = data.sessionToken;
                    localStorage.setItem('no3d_session_token', sessionToken);

                    // Store customer info
                    customerId = data.customer.id;
                    customerEmail = data.customer.email;
                    localStorage.setItem('customer_email', customerEmail);

                    // Load account data
                    await loadAccountData();
                } else {
                    document.getElementById('loading-state').style.display = 'none';
                    document.getElementById('error-state').style.display = 'block';
                    document.getElementById('error-message').textContent = data.error || 'Invalid or expired magic link';

                    // Show login prompt after 3 seconds
                    setTimeout(() => {
                        document.getElementById('error-state').style.display = 'none';
                        showLoginPrompt();
                    }, 3000);
                }
            } catch (error) {
                console.error('Error verifying magic link:', error);
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'block';
                document.getElementById('error-message').textContent = 'Failed to verify magic link';

                setTimeout(() => {
                    document.getElementById('error-state').style.display = 'none';
                    showLoginPrompt();
                }, 3000);
            }
        }

        /**
         * Show authentication message
         */
        function showAuthMessage(message, type) {
            const messageDiv = document.getElementById('auth-message');
            messageDiv.textContent = message;
            messageDiv.className = `auth-message ${type}`;
            messageDiv.style.display = 'block';

            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 5000);
            }
        }

        /**
         * Validate email format
         */
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        /**
         * Handle Enter key in email input
         */
        document.addEventListener('DOMContentLoaded', () => {
            const emailInput = document.getElementById('auth-email');
            if (emailInput) {
                emailInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        sendMagicLink();
                    }
                });
            }
        });

        /**
         * Handle session expiration
         */
        function handleSessionExpired() {
            console.log('Session expired');
            localStorage.removeItem('no3d_session_token');
            sessionToken = null;
            customerId = null;

            // Hide account content
            document.getElementById('account-content').style.display = 'none';
            document.getElementById('loading-state').style.display = 'none';

            // Show error message
            document.getElementById('error-state').style.display = 'block';
            document.getElementById('error-message').textContent = 'Your session has expired. Please sign in again.';

            // Show login prompt after 3 seconds
            setTimeout(() => {
                document.getElementById('error-state').style.display = 'none';
                showLoginPrompt();
            }, 3000);
        }

        async function loadAccountData() {
            try {
                document.getElementById('loading-state').style.display = 'block';
                document.getElementById('error-state').style.display = 'none';
                document.getElementById('login-prompt').style.display = 'none';

                // Load subscription data
                await loadSubscriptionStatus();

                // Load catalog version for update detection
                await loadCatalogVersion();

                // Load orders
                await loadOrders();

                // Load library files
                await loadLibraryFiles();

                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('login-prompt').style.display = 'none';
                document.getElementById('account-content').style.display = 'block';
            } catch (error) {
                console.error('Error loading account data:', error);
                document.getElementById('loading-state').style.display = 'none';
                document.getElementById('error-state').style.display = 'block';
                document.getElementById('error-message').textContent = error.message || 'Failed to load account information';
            }
        }

        async function loadSubscriptionStatus() {
            try {
                // Call API to get subscription status
                const response = await fetch(`/api/v1/user/entitlements?customer_id=${customerId}`);
                
                if (response.ok) {
                    const data = await response.json();
                    subscriptionData = data;
                    updateSubscriptionUI(data);
                } else if (response.status === 401) {
                    // Not authenticated, show login
                    sessionStorage.removeItem('polar_customer_id');
                    showLoginPrompt();
                } else {
                    throw new Error('Failed to load subscription status');
                }
            } catch (error) {
                console.error('Error loading subscription:', error);
                // Use actual customer data from session, not mock data
                updateSubscriptionUI({
                    user: {
                        id: customerId,
                        email: customerEmail || localStorage.getItem('customer_email') || '-',
                        name: null
                    },
                    entitlements: null
                });
            }
        }

        function updateSubscriptionUI(data) {
            const { user, entitlements } = data;

            // Update customer name and email
            const customerName = user.name || user.email?.split('@')[0] || 'User';
            const customerNameEl = document.getElementById('customer-name');
            const customerEmailEl = document.getElementById('customer-email');

            if (customerNameEl) customerNameEl.textContent = customerName;
            if (customerEmailEl) customerEmailEl.textContent = user.email || '-';

            // Store customer email for credit balance
            if (user.email) {
                customerEmail = user.email;
            }

            // Update status badge (if element exists)
            const statusBadge = document.getElementById('status-badge');
            const isActive = entitlements && entitlements.expires_at && new Date(entitlements.expires_at) > new Date();

            if (statusBadge) {
                if (isActive) {
                    statusBadge.textContent = 'Active';
                    statusBadge.className = 'status-badge active';
                } else {
                    statusBadge.textContent = 'Expired';
                    statusBadge.className = 'status-badge expired';
                }
            }

            // Hide subscribe button in header if user is subscribed
            if (isActive) {
                const subscribeLink = document.getElementById('subscribe-header-link');
                if (subscribeLink) {
                    subscribeLink.style.display = 'none';
                }
            }

            // Update subscription info (if elements exist)
            const planNameEl = document.getElementById('plan-name');
            const subscriptionStatusEl = document.getElementById('subscription-status');
            const renewalDateEl = document.getElementById('renewal-date');

            if (planNameEl) planNameEl.textContent = 'Full Access';
            if (subscriptionStatusEl) subscriptionStatusEl.textContent = isActive ? 'Active' : 'Expired';

            if (renewalDateEl && entitlements && entitlements.expires_at) {
                const renewalDate = new Date(entitlements.expires_at);
                renewalDateEl.textContent = renewalDate.toLocaleDateString();
            }
        }

        async function loadCatalogVersion() {
            try {
                const response = await fetch('/api/v1/catalog/version');
                if (response.ok) {
                    const data = await response.json();
                    catalogVersion = data.version;
                    checkForUpdates();
                }
            } catch (error) {
                console.error('Error loading catalog version:', error);
            }
        }

        async function loadLibraryFiles() {
            const filesList = document.getElementById('library-files-list');
            if (!filesList) return;

            try {
                // Fetch owned products from orders API
                const response = await fetch('/api/customer/orders?page=1&limit=100', {
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`,
                    },
                });

                if (response.status === 401) {
                    handleSessionExpired();
                    return;
                }

                if (response.ok) {
                    const data = await response.json();
                    const ownedProducts = extractOwnedProducts(data.orders);
                    displayLibraryFiles(ownedProducts);
                } else {
                    // Fallback to mock data if API fails
                    displayLibraryFiles(getMockLibraryFiles());
                }
            } catch (error) {
                console.error('Error loading library files:', error);
                // Show mock data for preview
                displayLibraryFiles(getMockLibraryFiles());
            }
        }

        function extractOwnedProducts(orders) {
            const productsMap = new Map();

            if (!orders || orders.length === 0) {
                return [];
            }

            // Extract unique products from paid orders
            for (const order of orders) {
                if (order.status !== 'paid') continue;

                if (order.products && Array.isArray(order.products)) {
                    for (const product of order.products) {
                        if (!productsMap.has(product.id)) {
                            productsMap.set(product.id, {
                                id: product.id,
                                name: product.name,
                                handle: product.handle,
                                path: product.handle || product.id,
                                files: ['Product files available for download'],
                                category: 'Product',
                            });
                        }
                    }
                }
            }

            return Array.from(productsMap.values());
        }

        function getMockLibraryFiles() {
            // Mock library files for preview
            return [
                { name: 'Dojo_Assets_001', path: 'DojoAssets/Dojo_Assets_001', files: ['asset.blend', 'metadata.json', 'icon.png'], category: 'Assets' },
                { name: 'Dojo_Assets_002', path: 'DojoAssets/Dojo_Assets_002', files: ['asset.blend', 'metadata.json', 'icon.png'], category: 'Assets' },
                { name: 'Dojo_Tools_001', path: 'DojoTools/Dojo_Tools_001', files: ['tool.blend', 'metadata.json', 'preview.png'], category: 'Tools' },
                { name: 'Dojo_Tools_002', path: 'DojoTools/Dojo_Tools_002', files: ['tool.blend', 'metadata.json', 'preview.png'], category: 'Tools' },
                { name: 'Dojo_Environments_001', path: 'DojoEnvironments/Dojo_Environments_001', files: ['env.blend', 'metadata.json', 'icon.png'], category: 'Environments' },
                { name: 'Dojo_Materials_001', path: 'DojoMaterials/Dojo_Materials_001', files: ['material.blend', 'metadata.json', 'preview.png'], category: 'Materials' },
            ];
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function displayLibraryFiles(files) {
            const filesList = document.getElementById('library-files-list');
            if (!filesList) return;

            if (!files || files.length === 0) {
                filesList.innerHTML = `
                    <div class="library-files-empty">
                        <p>No library files yet.</p>
                        <p style="margin-top: var(--space-small); font-size: var(--font-size-small);">
                            Purchase products to access your library files here.
                        </p>
                        <a href="index.html#products" class="action-link" style="margin-top: var(--space-medium); display: inline-block;">
                            Browse Products
                        </a>
                    </div>
                `;
                return;
            }

            filesList.innerHTML = files.map((file, index) => {
                const fileCount = file.files ? file.files.length : 0;
                const fileTypes = file.files ? file.files.map(f => {
                    const ext = f.split('.').pop();
                    return ext.toUpperCase();
                }).join(', ') : '';

                const fileName = escapeHtml(file.name || 'Unnamed Product');
                const filePath = escapeHtml(file.path || '');
                const fileCategory = escapeHtml(file.category || 'Product');
                const productId = file.id || '';

                return `
                    <div class="library-file-item" data-file-path="${filePath}" data-file-name="${fileName}" data-product-id="${productId}">
                        <div class="library-file-download-icon" onclick="downloadProductFromLibrary(event, '${productId}', ${JSON.stringify(fileName)})" title="Download ${fileName}">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                            </svg>
                        </div>
                        <div class="library-file-name">${fileName}</div>
                        <div class="library-file-path">${filePath}</div>
                        <div class="library-file-meta">
                            <span>${fileCount} files</span>
                            <span>${fileCategory}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function downloadProductFromLibrary(event, productId, productName) {
            event.stopPropagation();

            if (!productId) {
                alert('Product ID not available.');
                return;
            }

            // Use the downloadProduct function
            await downloadProduct(productId, productName);
        }

        function checkForUpdates() {
            const lastDownloadVersion = localStorage.getItem('last_download_version');
            const lastDownloadDate = localStorage.getItem('last_download_date');

            if (lastDownloadDate) {
                document.getElementById('last-download-date').textContent = new Date(lastDownloadDate).toLocaleString();
            }

            if (lastDownloadVersion && catalogVersion && parseInt(lastDownloadVersion) < parseInt(catalogVersion)) {
                document.getElementById('update-badge').style.display = 'inline-block';
            }
        }

        // ============================================
        // Orders Functions
        // ============================================

        let currentOrdersPage = 1;

        async function loadOrders(page = 1) {
            const ordersList = document.getElementById('orders-list');
            const paginationDiv = document.getElementById('orders-pagination');

            if (!ordersList) return;

            try {
                // Show loading state
                if (page === 1) {
                    ordersList.innerHTML = '<div class="loading">Loading orders...</div>';
                }

                const response = await fetch(`/api/customer/orders?page=${page}&limit=10`, {
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`,
                    },
                });

                if (response.status === 401) {
                    handleSessionExpired();
                    return;
                }

                if (!response.ok) {
                    throw new Error('Failed to load orders');
                }

                const data = await response.json();

                currentOrdersPage = page;

                // Display orders
                displayOrders(data.orders);

                // Display pagination
                displayOrdersPagination(data.pagination);
            } catch (error) {
                console.error('Error loading orders:', error);
                ordersList.innerHTML = '<div class="orders-empty">Failed to load orders. Please try again later.</div>';
                paginationDiv.style.display = 'none';
            }
        }

        function displayOrders(orders) {
            const ordersList = document.getElementById('orders-list');

            if (!orders || orders.length === 0) {
                ordersList.innerHTML = `
                    <div class="orders-empty">
                        <p>No orders yet.</p>
                        <p style="margin-top: var(--space-small); font-size: var(--font-size-small);">
                            Your purchase history will appear here.
                        </p>
                        <a href="index.html#products" class="action-link" style="margin-top: var(--space-medium); display: inline-block;">
                            Browse Products
                        </a>
                    </div>
                `;
                return;
            }

            ordersList.innerHTML = orders.map(order => renderOrderCard(order)).join('');
        }

        function renderOrderCard(order) {
            const date = new Date(order.createdAt).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
            });

            const amount = formatCurrency(order.amount, order.currency);
            const statusClass = order.status === 'paid' ? 'paid' : 'pending';
            const statusText = order.status.toUpperCase();

            const products = order.products.map(product => {
                return `
                    <div class="order-product">
                        ${escapeHtml(product.name)}
                    </div>
                `;
            }).join('');

            const downloadButtons = order.products.map(product => {
                return `
                    <button class="download-button" style="font-size: var(--font-size-small); padding: var(--space-tiny) var(--space-small);"
                            onclick="downloadProduct('${product.id}', '${escapeHtml(product.name)}')">
                        Download ${escapeHtml(product.name)}
                    </button>
                `;
            }).join('');

            const invoiceLink = order.invoiceUrl
                ? `<a href="${order.invoiceUrl}" target="_blank" class="order-invoice-link">View Invoice</a>`
                : '';

            return `
                <div class="order-card">
                    <div class="order-header">
                        <div>
                            <div class="order-id">Order #${order.id.slice(0, 8)}</div>
                            <div class="order-date">${date}</div>
                        </div>
                        <span class="order-status ${statusClass}">${statusText}</span>
                    </div>
                    <div class="order-products">
                        ${products}
                    </div>
                    <div class="order-amount">${amount}</div>
                    <div class="order-actions">
                        ${downloadButtons}
                        ${invoiceLink}
                    </div>
                </div>
            `;
        }

        function displayOrdersPagination(pagination) {
            const paginationDiv = document.getElementById('orders-pagination');

            if (!pagination || pagination.totalPages <= 1) {
                paginationDiv.style.display = 'none';
                return;
            }

            paginationDiv.style.display = 'flex';

            const prevDisabled = pagination.page <= 1;
            const nextDisabled = pagination.page >= pagination.totalPages;

            paginationDiv.innerHTML = `
                <button class="pagination-button" ${prevDisabled ? 'disabled' : ''} onclick="loadOrders(${pagination.page - 1})">
                    Previous
                </button>
                <span class="pagination-info">
                    Page ${pagination.page} of ${pagination.totalPages}
                </span>
                <button class="pagination-button" ${nextDisabled ? 'disabled' : ''} onclick="loadOrders(${pagination.page + 1})">
                    Next
                </button>
            `;
        }

        async function downloadProduct(productId, productName) {
            if (!sessionToken) {
                alert('Please sign in to download products.');
                return;
            }

            try {
                const response = await fetch('/api/customer/download', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${sessionToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ productId: productId }),
                });

                if (response.status === 401) {
                    handleSessionExpired();
                    return;
                }

                if (response.status === 403) {
                    alert('You do not have access to this product.');
                    return;
                }

                if (!response.ok) {
                    throw new Error('Failed to generate download URL');
                }

                const data = await response.json();

                if (data.error) {
                    alert(data.error);
                    return;
                }

                if (data.downloadUrl) {
                    // Open download URL in new tab
                    window.open(data.downloadUrl, '_blank');
                } else {
                    alert('Download URL not available yet. This feature is coming soon!');
                }
            } catch (error) {
                console.error('Error downloading product:', error);
                alert('Failed to download product. Please try again later.');
            }
        }

        function formatCurrency(amountCents, currency = 'usd') {
            const amount = amountCents / 100;
            const formatter = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: currency.toUpperCase(),
            });
            return formatter.format(amount);
        }

        async function downloadAllFiles() {
            if (!customerId) {
                alert('Please sign in to download files.');
                return;
            }

            const downloadButton = document.getElementById('download-all-button');
            const downloadProgress = document.getElementById('download-progress');
            
            // Show progress
            downloadButton.disabled = true;
            downloadProgress.style.display = 'block';
            downloadButton.textContent = 'Preparing Download...';

            try {
                const response = await fetch(`/api/v1/library/download?customer_id=${customerId}`);
                
                if (!response.ok) {
                    if (response.status === 403) {
                        throw new Error('Active subscription required to download files.');
                    } else if (response.status === 400) {
                        throw new Error('Customer ID required.');
                    } else {
                        throw new Error('Failed to download library. Please try again later.');
                    }
                }

                // Get the ZIP file as a blob
                const blob = await response.blob();
                const catalogVersion = response.headers.get('X-Catalog-Version') || 'latest';
                
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `no3d-tools-library-${catalogVersion}.zip`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                // Update last download info
                const now = new Date();
                localStorage.setItem('last_download_date', now.toISOString());
                localStorage.setItem('last_download_version', catalogVersion);
                document.getElementById('last-download-date').textContent = now.toLocaleString();
                
                // Hide progress
                downloadProgress.style.display = 'none';
                downloadButton.textContent = 'Download All Files';
                downloadButton.disabled = false;
            } catch (error) {
                console.error('Error downloading library:', error);
                alert(error.message || 'Failed to download library. Please try again later.');
                downloadProgress.style.display = 'none';
                downloadButton.textContent = 'Download All Files';
                downloadButton.disabled = false;
            }
        }


        function handleLogout(event) {
            event.preventDefault();
            // Clear session token
            localStorage.removeItem('no3d_session_token');
            localStorage.removeItem('last_download_version');
            localStorage.removeItem('last_download_date');
            localStorage.removeItem('customer_email');
            sessionToken = null;
            customerId = null;
            window.location.href = 'index.html';
        }

        // Set billing link (would be configured based on Polar setup)
        document.getElementById('billing-link').href = 'https://polar.sh/account';

        // ============================================
        // Credit Balance Functions
        // ============================================

        let customerEmail = null;

        async function loadCreditBalance() {
            if (!customerEmail) {
                console.log('No customer email available for credit balance');
                return;
            }

            try {
                const headers = {
                    'Content-Type': 'application/json',
                };

                // Add Authorization header if session token exists
                if (sessionToken) {
                    headers['Authorization'] = `Bearer ${sessionToken}`;
                }

                const response = await fetch(`/api/credit/balance?email=${encodeURIComponent(customerEmail)}`, {
                    headers: headers,
                });

                if (response.ok) {
                    const data = await response.json();
                    updateCreditBalanceUI(data.balance);

                    // Store email in localStorage for checkout flow
                    localStorage.setItem('customer_email', customerEmail);
                } else if (response.status === 401) {
                    // Session expired, show login prompt
                    handleSessionExpired();
                }
            } catch (error) {
                console.error('Error loading credit balance:', error);
            }
        }

        function updateCreditBalanceUI(balanceCents) {
            const balanceElement = document.getElementById('credit-balance');
            const formattedBalance = `$${(balanceCents / 100).toFixed(2)}`;
            balanceElement.textContent = formattedBalance;

            if (balanceCents > 0) {
                balanceElement.classList.add('has-credit');
            } else {
                balanceElement.classList.remove('has-credit');
            }
        }

        async function loadCreditHistory() {
            if (!customerEmail) return;

            try {
                const headers = {
                    'Content-Type': 'application/json',
                };

                if (sessionToken) {
                    headers['Authorization'] = `Bearer ${sessionToken}`;
                }

                const response = await fetch(`/api/credit/history?email=${encodeURIComponent(customerEmail)}&limit=10`, {
                    headers: headers,
                });

                if (response.ok) {
                    const data = await response.json();
                    displayCreditHistory(data.transactions);
                } else if (response.status === 401) {
                    handleSessionExpired();
                }
            } catch (error) {
                console.error('Error loading credit history:', error);
            }
        }

        function displayCreditHistory(transactions) {
            const container = document.getElementById('credit-history-container');
            const list = document.getElementById('credit-history-list');

            if (!transactions || transactions.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            list.innerHTML = transactions.map(txn => {
                const isPositive = txn.amount >= 0;
                const amountClass = isPositive ? 'positive' : 'negative';
                const date = new Date(txn.createdAt).toLocaleDateString();

                return `
                    <div class="credit-history-item">
                        <div>
                            <div>${escapeHtml(txn.description)}</div>
                            <div class="credit-history-date">${date}</div>
                        </div>
                        <div class="credit-history-amount ${amountClass}">
                            ${txn.amountFormatted}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function redeemGiftCard() {
            const codeInput = document.getElementById('gift-card-code');
            const redeemButton = document.getElementById('redeem-button');
            const messageDiv = document.getElementById('redeem-message');
            const code = codeInput.value.trim().toUpperCase();

            if (!code) {
                showRedeemMessage('Please enter a gift card code', false);
                return;
            }

            if (!customerEmail) {
                showRedeemMessage('Please sign in to redeem gift cards', false);
                return;
            }

            // Disable button during request
            redeemButton.disabled = true;
            redeemButton.textContent = 'Redeeming...';

            try {
                const headers = {
                    'Content-Type': 'application/json',
                };

                if (sessionToken) {
                    headers['Authorization'] = `Bearer ${sessionToken}`;
                }

                const response = await fetch('/api/credit/redeem', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        code: code,
                        email: customerEmail,
                    }),
                });

                const data = await response.json();

                if (data.success) {
                    showRedeemMessage(data.message, true);
                    codeInput.value = '';
                    updateCreditBalanceUI(data.newBalance);
                    await loadCreditHistory();
                    await loadPurchasedGiftCards();
                } else {
                    showRedeemMessage(data.message || data.error || 'Failed to redeem code', false);
                }
            } catch (error) {
                console.error('Error redeeming gift card:', error);
                showRedeemMessage('An error occurred. Please try again.', false);
            } finally {
                redeemButton.disabled = false;
                redeemButton.textContent = 'Redeem';
            }
        }

        function showRedeemMessage(message, isSuccess) {
            const messageDiv = document.getElementById('redeem-message');
            messageDiv.textContent = message;
            messageDiv.className = `redeem-message ${isSuccess ? 'success' : 'error'}`;
            messageDiv.style.display = 'block';

            // Auto-hide after 5 seconds
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        async function loadPurchasedGiftCards() {
            if (!customerEmail) {
                return;
            }

            const container = document.getElementById('purchased-giftcards-container');
            const listEl = document.getElementById('purchased-giftcards-list');

            try {
                const headers = {};
                if (sessionToken) {
                    headers['Authorization'] = `Bearer ${sessionToken}`;
                }

                const response = await fetch(`/api/gift-cards/purchased?email=${encodeURIComponent(customerEmail)}`, {
                    headers: headers,
                });

                if (!response.ok) {
                    throw new Error('Failed to load purchased gift cards');
                }

                const data = await response.json();

                if (data.success && data.giftCards && data.giftCards.length > 0) {
                    container.style.display = 'block';
                    listEl.innerHTML = data.giftCards.map(card => {
                        const isRedeemed = card.redeemedAt !== null;
                        const valueFormatted = `$${(card.valueCents / 100).toFixed(2)}`;
                        const createdDate = new Date(card.createdAt).toLocaleDateString();

                        let detailsText = '';
                        if (card.type === 'months') {
                            detailsText = `${card.months} Month Membership`;
                        } else if (card.type === 'credit') {
                            detailsText = `Store Credit`;
                        }

                        if (isRedeemed) {
                            const redeemedDate = new Date(card.redeemedAt).toLocaleDateString();
                            detailsText += `  Redeemed ${redeemedDate}`;
                            if (card.redeemedBy) {
                                detailsText += ` by ${card.redeemedBy}`;
                            }
                        } else {
                            detailsText += `  Purchased ${createdDate}`;
                        }

                        return `
                            <div class="giftcard-item ${isRedeemed ? 'redeemed' : ''}">
                                <div class="giftcard-info">
                                    <div class="giftcard-code">${card.code}</div>
                                    <div class="giftcard-details">${detailsText}</div>
                                </div>
                                <div style="display: flex; flex-direction: column; align-items: flex-end; gap: var(--space-tiny);">
                                    <div class="giftcard-value">${valueFormatted}</div>
                                    <div class="giftcard-status ${isRedeemed ? 'redeemed' : 'active'}">
                                        ${isRedeemed ? 'REDEEMED' : 'ACTIVE'}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    // Don't show the section if there are no gift cards
                    container.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading purchased gift cards:', error);
                // Don't show the section if there's an error
                container.style.display = 'none';
            }
        }

        // Format gift card code input
        document.getElementById('gift-card-code').addEventListener('input', function(e) {
            let value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');

            // Add dashes after every 4 characters (DOJO-XXXX-XXXX-XXXX)
            let formatted = '';
            for (let i = 0; i < value.length && i < 16; i++) {
                if (i > 0 && i % 4 === 0) {
                    formatted += '-';
                }
                formatted += value[i];
            }

            e.target.value = formatted;
        });

        // Update loadAccountData to include credit functions
        const originalLoadAccountData = loadAccountData;
        loadAccountData = async function() {
            await originalLoadAccountData();

            // Get customer email from subscription data
            if (subscriptionData && subscriptionData.user && subscriptionData.user.email) {
                customerEmail = subscriptionData.user.email;
                await loadCreditBalance();
                await loadCreditHistory();
                await loadPurchasedGiftCards();
            }

            // Load subscriptions
            await loadSubscriptions();
        };

        // ============================================
        // Subscription Management Functions
        // ============================================

        let currentCancelSubscriptionId = null;

        /**
         * Load subscriptions from API
         */
        async function loadSubscriptions() {
            const subscriptionsList = document.getElementById('subscriptions-list');
            if (!subscriptionsList) return;

            try {
                const headers = {
                    'Content-Type': 'application/json',
                };

                if (sessionToken) {
                    headers['Authorization'] = `Bearer ${sessionToken}`;
                }

                const response = await fetch('/api/customer/subscriptions', {
                    headers: headers,
                });

                if (response.ok) {
                    const data = await response.json();
                    displaySubscriptions(data.subscriptions);
                } else if (response.status === 401) {
                    handleSessionExpired();
                } else if (response.status === 404) {
                    // API endpoint doesn't exist yet, show empty state
                    displaySubscriptions([]);
                } else {
                    console.error('Failed to load subscriptions');
                    displaySubscriptions([]);
                }
            } catch (error) {
                console.error('Error loading subscriptions:', error);
                // Show empty state instead of error for better UX
                displaySubscriptions([]);
            }
        }

        /**
         * Display subscriptions in UI
         */
        function displaySubscriptions(subscriptions) {
            const subscriptionsList = document.getElementById('subscriptions-list');
            if (!subscriptionsList) return;

            if (!subscriptions || subscriptions.length === 0) {
                subscriptionsList.innerHTML = `
                    <div class="loading" style="color: var(--color-dark-gray);">
                        No active subscriptions found.
                        <a href="subscribe.html" class="action-link" style="margin-left: var(--space-small); display: inline-block;">Subscribe Now</a>
                    </div>
                `;
                return;
            }

            subscriptionsList.innerHTML = subscriptions.map(sub => {
                const productName = sub.product ? sub.product.name : 'Subscription';
                const amount = sub.amount / 100;
                const currency = sub.currency.toUpperCase();
                const interval = sub.interval;
                const status = sub.status || 'active';
                const cancelAtPeriodEnd = sub.cancelAtPeriodEnd;

                const periodStart = sub.currentPeriodStart ? new Date(sub.currentPeriodStart).toLocaleDateString() : '-';
                const periodEnd = sub.currentPeriodEnd ? new Date(sub.currentPeriodEnd).toLocaleDateString() : '-';

                let statusBadgeClass = 'active';
                let statusText = 'Active';

                if (status === 'canceled' || cancelAtPeriodEnd) {
                    statusBadgeClass = 'inactive';
                    statusText = cancelAtPeriodEnd ? 'Cancels at Period End' : 'Canceled';
                } else if (status === 'past_due') {
                    statusBadgeClass = 'expired';
                    statusText = 'Past Due';
                }

                const warningHtml = cancelAtPeriodEnd
                    ? `<div class="warning-message">This subscription will cancel on ${periodEnd}. You will lose access after this date.</div>`
                    : '';

                const actionButtons = cancelAtPeriodEnd
                    ? `<button onclick="reactivateSubscription('${sub.id}')">Reactivate Subscription</button>`
                    : status === 'active'
                        ? `<button class="danger" onclick="showCancelModal('${sub.id}')">Cancel Subscription</button>`
                        : '';

                return `
                    <div class="subscription-card">
                        <div class="subscription-card-header">
                            <div class="subscription-product-name">${escapeHtml(productName)}</div>
                            <div class="subscription-price">$${amount.toFixed(2)}/${interval}</div>
                        </div>
                        <div>
                            <span class="status-badge ${statusBadgeClass}">${statusText}</span>
                        </div>
                        ${warningHtml}
                        <div class="subscription-details">
                            <div class="subscription-detail">
                                <div class="subscription-detail-label">Period Start</div>
                                <div>${periodStart}</div>
                            </div>
                            <div class="subscription-detail">
                                <div class="subscription-detail-label">Period End</div>
                                <div>${periodEnd}</div>
                            </div>
                            <div class="subscription-detail">
                                <div class="subscription-detail-label">Status</div>
                                <div>${escapeHtml(status)}</div>
                            </div>
                        </div>
                        ${actionButtons ? `<div class="subscription-actions">${actionButtons}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        /**
         * Show cancel subscription modal
         */
        function showCancelModal(subscriptionId) {
            currentCancelSubscriptionId = subscriptionId;
            const modal = document.getElementById('cancel-modal');
            if (modal) {
                modal.classList.add('active');
            }
        }

        /**
         * Close cancel subscription modal
         */
        function closeCancelModal() {
            const modal = document.getElementById('cancel-modal');
            if (modal) {
                modal.classList.remove('active');
            }
            currentCancelSubscriptionId = null;
        }

        /**
         * Confirm cancellation
         */
        async function confirmCancel() {
            if (!currentCancelSubscriptionId) {
                return;
            }

            const cancelType = document.querySelector('input[name="cancel-type"]:checked')?.value;
            const reason = document.getElementById('cancel-reason')?.value;
            const immediately = cancelType === 'immediately';

            try {
                const headers = {
                    'Content-Type': 'application/json',
                };

                if (sessionToken) {
                    headers['Authorization'] = `Bearer ${sessionToken}`;
                }

                const response = await fetch('/api/customer/subscriptions/cancel', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        subscriptionId: currentCancelSubscriptionId,
                        immediately: immediately,
                        reason: reason || undefined,
                    }),
                });

                const data = await response.json();

                if (data.success) {
                    closeCancelModal();
                    alert(immediately
                        ? 'Subscription cancelled immediately. You no longer have access.'
                        : 'Subscription will cancel at the end of the current billing period.');
                    await loadSubscriptions();
                } else {
                    alert(data.error || 'Failed to cancel subscription');
                }
            } catch (error) {
                console.error('Error cancelling subscription:', error);
                alert('An error occurred while cancelling subscription');
            }
        }

        /**
         * Reactivate subscription
         */
        async function reactivateSubscription(subscriptionId) {
            if (!confirm('Reactivate this subscription? It will continue renewing at the end of the current period.')) {
                return;
            }

            try {
                const headers = {
                    'Content-Type': 'application/json',
                };

                if (sessionToken) {
                    headers['Authorization'] = `Bearer ${sessionToken}`;
                }

                const response = await fetch('/api/customer/subscriptions/reactivate', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify({
                        subscriptionId: subscriptionId,
                    }),
                });

                const data = await response.json();

                if (data.success) {
                    alert('Subscription reactivated successfully!');
                    await loadSubscriptions();
                } else {
                    alert(data.error || 'Failed to reactivate subscription');
                }
            } catch (error) {
                console.error('Error reactivating subscription:', error);
                alert('An error occurred while reactivating subscription');
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('cancel-modal');
            if (modal && e.target === modal) {
                closeCancelModal();
            }
        });
    </script>
</body>
</html>






















