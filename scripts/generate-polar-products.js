#!/usr/bin/env node

/**
 * Generate polar-products.js from Polar API
 *
 * This script fetches the latest product data from Polar API and generates
 * the polar-products.js file with current product IDs and price IDs.
 *
 * Usage:
 *   node scripts/generate-polar-products.js
 */

import { Polar } from '@polar-sh/sdk';
import 'dotenv/config';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Initialize Polar SDK
const polar = new Polar({
  accessToken: process.env.POLAR_API_TOKEN
});

// Mapping of Polar product names to handle slugs
const PRODUCT_HANDLE_MAP = {
  'Dojo Bolt Gen v05': 'dojo-bolt-gen-v05',
  'Dojo Bolt Gen v05_Obj': 'dojo-bolt-gen-v05-obj',
  'Dojo Bool v5': 'dojo-bool-v5',
  'Dojo Calipers': 'dojo-calipers',
  'Dojo Crv Wrapper v4': 'dojo-crv-wrapper-v4',
  'Dojo Gluefinity Grid_obj': 'dojo-gluefinity-grid-obj',
  'Dojo Knob': 'dojo-knob',
  'Dojo Knob_obj': 'dojo-knob-obj',
  'Dojo Mesh Repair': 'dojo-mesh-repair',
  'Dojo Print Viz_V4.5': 'dojo-print-viz-v45',
  'Dojo Squircle v4.5_obj': 'dojo-squircle-v45-obj',
  'Dojo_Squircle v4.5': 'dojo-squircle-v45'
};

async function generatePolarProducts() {
  try {
    if (!process.env.POLAR_API_TOKEN) {
      console.error('ERROR: POLAR_API_TOKEN not found in environment');
      console.error('Make sure you have a .env file with POLAR_API_TOKEN set');
      process.exit(1);
    }

    console.log('\n=== Generating polar-products.js ===\n');

    const organizationId = process.env.POLAR_ORG_ID || 'f0c16049-5959-42c9-8be8-5952c38c7d63';

    // Fetch products from Polar
    console.log('üì° Fetching products from Polar API...');
    const result = await polar.products.list({
      organizationId: organizationId,
      limit: 100,
      isArchived: false
    });

    const products = result.result?.items || [];
    console.log(`‚úÖ Found ${products.length} active products\n`);

    // Build product mapping object (deduplicate by name)
    const productMap = new Map();

    for (const product of products) {
      const handle = PRODUCT_HANDLE_MAP[product.name];
      if (!handle) {
        continue; // Skip products without handle mapping
      }

      // Get the first price ID (products should have one price)
      const priceId = product.prices && product.prices.length > 0
        ? product.prices[0].id
        : null;

      if (!priceId) {
        console.log(`‚ö†Ô∏è  No price found for: ${product.name}`);
        continue;
      }

      // Only keep the first occurrence of each product name
      if (!productMap.has(product.name)) {
        productMap.set(product.name, {
          handle,
          productId: product.id,
          priceId,
          name: product.name
        });
        console.log(`‚úì ${product.name.padEnd(35)} ‚Üí ${handle}`);
      }
    }

    // Convert map to array
    const productEntries = Array.from(productMap.values());

    // Sort by handle for consistency
    productEntries.sort((a, b) => a.handle.localeCompare(b.handle));

    // Generate the JavaScript file content
    const timestamp = new Date().toISOString();
    let fileContent = `// Polar Product Mapping with Price IDs
// Auto-generated by scripts/generate-polar-products.js
// Last updated: ${timestamp}
// NOTE: Handles must match the "handle" field in product JSON files

const POLAR_PRODUCTS = {\n`;

    for (const entry of productEntries) {
      fileContent += `  '${entry.handle}': {\n`;
      fileContent += `    productId: '${entry.productId}',\n`;
      fileContent += `    priceId: '${entry.priceId}',\n`;
      fileContent += `    name: '${entry.name}',\n`;
      fileContent += `    url: 'https://polar.sh/no3d-tools'\n`;
      fileContent += `  },\n`;
    }

    fileContent += `};

// Polar organization base URL (checkout links)
const POLAR_ORG_URL = 'https://polar.sh/no3d-tools';

// Export for use in website
if (typeof module !== 'undefined' && module.exports) {
  module.exports = { POLAR_PRODUCTS, POLAR_ORG_URL };
}
`;

    // Write the file
    const outputPath = path.join(__dirname, '..', 'polar-products.js');
    fs.writeFileSync(outputPath, fileContent, 'utf8');

    console.log(`\n‚úÖ Generated polar-products.js with ${productEntries.length} products`);
    console.log(`üìÅ File: ${outputPath}\n`);

  } catch (error) {
    console.error('\nERROR: Failed to generate polar-products.js');
    console.error('Status:', error.statusCode || 'unknown');
    console.error('Message:', error.message);
    if (error.body) {
      console.error('Details:', error.body);
    }
    process.exit(1);
  }
}

generatePolarProducts();
